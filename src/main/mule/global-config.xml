<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns:sockets="http://www.mulesoft.org/schema/mule/sockets"
	xmlns:tls="http://www.mulesoft.org/schema/mule/tls"
	xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway" xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/sockets http://www.mulesoft.org/schema/mule/sockets/current/mule-sockets.xsd 
http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd">
	<!-- <configuration-properties doc:name="Configuration properties" doc:id="5cda403a-e192-4f4f-bf8b-351f4b21ef66" file="properties\local.yaml" /> -->
	<api-gateway:autodiscovery apiId="${api.autodiscovery.id}" ignoreBasePath="true" doc:name="API Autodiscovery" doc:id="83ded0e2-f303-492c-93d2-bc99082ace31" flowRef="sgst-mm-edi-eapi-main" />
	
	 <http:listener-config name="sgst-mm-edi-eapi-httpListenerConfig">
        <http:listener-connection host="${http.host}" port="${http.port}" readTimeout="${http.ReadTimeout}" protocol="HTTPS" tlsContext="TLS_Context"/>
    </http:listener-config>
     <apikit:config name="sgst-mm-edi-eapi-config" api="sgst-mm-edi-eapi.raml" outboundHeadersMapName="outboundHeaders" httpStatusVarName="httpStatus"/>
<!-- 	  <api-gateway:autodiscovery apiId="${api.autodiscovery.id}" ignoreBasePath="true" doc:name="API Autodiscovery" doc:id="aa2fadab-bd65-4cdc-8d89-daf4bd910287" flowRef="sgst-mm-edi-eapi-main" />   -->
	<http:request-config name="HTTP_Request_For_SAPI" doc:name="HTTP Request configuration" doc:id="fc30f76d-f9fe-42e2-b267-c9cc43627746" basePath="#[vars.httpConfig.path]" requestStreamingMode="ALWAYS" responseTimeout="${http.sapi.response.timeout}">
		<http:request-connection host="#[vars.httpConfig.host]" protocol="HTTPS" tlsContext="TLS_Context_SAPI" usePersistentConnections="false">
			<reconnection >
				<reconnect frequency="${http.sapi.reconnection.frequency}" count="${http.sapi.reconnection.count}"/>
			</reconnection>
			<http:client-socket-properties >
				<sockets:tcp-client-socket-properties connectionTimeout="${http.sapi.connections.timeout}" />
			</http:client-socket-properties>
		</http:request-connection>
	</http:request-config>
	<http:request-config name="HTTP_Request_For_Orders_PAPI" doc:name="HTTP Request configuration" doc:id="3522b377-543d-4bff-a809-e4cf50d749c2" basePath="${http.orders.papi.basepath}" responseTimeout="${http.papi.response.timeout}">
		<http:request-connection host="${http.orders.papi.host}" protocol="HTTPS" tlsContext="TLS_Context_SAPI" usePersistentConnections="false">
			<reconnection >
				<reconnect frequency="${http.papi.reconnection.frequency}" count="${http.papi.reconnection.count}"/>
			</reconnection>
			<http:client-socket-properties >
				<sockets:tcp-client-socket-properties connectionTimeout="${http.papi.connections.timeout}" />
			</http:client-socket-properties>
		</http:request-connection>
	</http:request-config>
	<http:request-config name="HTTP_Request_For_BackUPFile" doc:name="HTTP Request configuration" doc:id="e9d0180f-fb3a-4f19-b9e6-e8a84621c416" basePath="${notification.system.api.basepath}" requestStreamingMode="ALWAYS" responseTimeout="${http.pcs.response.timeout}">
		<http:request-connection host="${http.utilities.papi.host}" protocol="HTTPS" tlsContext="TLS_Context_SAPI" usePersistentConnections="false">
			<reconnection >
				<reconnect frequency="${http.pcs.reconnection.frequency}" count="${http.pcs.reconnection.count}" />
			</reconnection>
			<http:client-socket-properties >
				<sockets:tcp-client-socket-properties connectionTimeout="${http.pcs.connections.timeout}" />
			</http:client-socket-properties>
		</http:request-connection>
	</http:request-config>
	<global-property doc:name="Global Property" doc:id="e0beee06-29ca-4f42-9f8a-e4e2be392921" name="mule.env" value="sit" />
	<global-property doc:name="Global Property" doc:id="99f234e7-17b8-4f88-896b-f2a95bab5a11" name="secret.key" value="PanasonicDev2022" />
	<configuration-properties doc:name="Configuration properties" doc:id="73958c67-2798-496d-8bfb-413cdf2ce40d" file="properties/${mule.env}.yaml" />
	<secure-properties:config name="Secure_Properties_Config" doc:name="Secure Properties Config" doc:id="656e20da-1993-42bb-83c3-ef1577efbbba" file="properties/${mule.env}.yaml" key="${secret.key}" />
<anypoint-mq:config name="Anypoint_MQ_Config" doc:name="Anypoint MQ Config" doc:id="91fac576-f6d3-4f2d-ad3d-617a5d6d8e84" >
		<anypoint-mq:connection clientId="${amq.email.publish.client.id}" clientSecret="${amq.email.publish.client.secret}" url="${amq.email.publish.url}"/>
	</anypoint-mq:config>
	<configuration doc:name="Configuration" doc:id="9fdc6e14-eea2-44bd-ae1f-4da33e302e5d" defaultErrorHandler-ref="common-exception-handler" />
	<configuration-properties doc:name="Configuration properties" doc:id="0ae26d89-d9b8-4645-8408-df638a7a9bb9" file="properties\common.yaml" />
	 <api-gateway:autodiscovery apiId="${api.autodiscovery.id}" ignoreBasePath="true" doc:name="API Autodiscovery" doc:id="e3ac257f-70b1-4136-8ece-c23090da9c1f" flowRef="sgst-mm-edi-eapi-main" /> 
	<json-logger:config name="JSON_Logger_Config1" doc:name="JSON Logger Config" doc:id="132e9eaf-ed21-4d40-9a24-c4ef2eac22cf" environment="${mule.env}" />
	
	
	<tls:context name="TLS_Context" doc:name="TLS Context" doc:id="a6638e90-5c1e-4076-8f11-5adb750051d8" >
		<tls:key-store type="jks" path="${secure::tls.keystore.jksPath}" alias="${secure::tls.keystore.jksAlias}" keyPassword="${secure::tls.keystore.jksKey}" password="${secure::tls.keystore.jksPassword}"/>
	</tls:context>
	<tls:context name="TLS_Context_SAPI" doc:name="TLS Context" doc:id="095ed710-67ee-41d8-9788-a883b8fc5d33" >
		<tls:key-store type="jks" path="${secure::tls.keystore.jksPath}" alias="${secure::tls.keystore.jksAlias}" keyPassword="${secure::tls.keystore.jksKey}" password="${secure::tls.keystore.jksPassword}"/>
	</tls:context>
	<error-handler name="common-exception-handler" doc:id="2f64f20f-4127-4c66-98a1-5c4925c66219" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="dcc95b7a-feca-440e-abd1-887b6ce2973f" type="COMPRESSION:COULD_NOT_DECOMPRESS, COMPRESSION:INVALID_ARCHIVE, COMPRESSION:TOO_MANY_ENTRIES" >
			<json-logger:logger doc:name="Log - Decompression Failure" doc:id="4faf70b1-9bc7-4902-97c7-f008af28ebaf" config-ref="JSON_Logger_Config1" message='File Decompression Failure.' tracePoint="EXCEPTION" priority="ERROR" correlationId="#[vars.TransactionID]">
				<json-logger:content><![CDATA[#[%dw 2.0
output application/json
---
{
   "flowDirection": Mule::p('api.flowDirection'),
   "source": Mule::p('api.source'),
   "target": vars.fileDetails.externalSystem default "",
   "fileName": if(vars.fileDetails.flatFileName != null and vars.fileDetails.flatFileExtension != null)(vars.fileDetails.flatFileName as String ++ vars.fileDetails.flatFileExtension as String) else "" ,
   "errorCode": "",
   "errorMessage": "",
   "subsidiary": vars.fileDetails.subsidiary,
   "apiName": Mule::p('json.logger.application.name'),
   "action": Mule::p('api.action.process'),
   "status": Mule::p('api.status.failure')
}]]]></json-logger:content>
			</json-logger:logger>
			<flow-ref doc:name="Flow Reference" doc:id="265d6a54-6c37-4998-9cce-1e6880719c91" name="global-config-propagate-error"/>
			<async doc:name="Async" doc:id="6c29cbaa-c45e-4ff3-82b7-6149bbecde64" >
				<flow-ref doc:name="global-config-email-notification" doc:id="5b2fe77a-06aa-42c8-9bfa-654c1ba5538d" name="global-config-email-notification" />
			</async>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="19a74ed7-ecad-4310-99c3-ece8e74b78ba" type="APIKIT:BAD_REQUEST">
			<flow-ref doc:name="Flow Reference" doc:id="0d866432-6871-4806-a9fb-bbd4279dc18e" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="a081cc78-d933-4258-8fbf-f39ec78b20da" type="APIKIT:NOT_FOUND" >
			<flow-ref doc:name="Flow Reference" doc:id="cc88b5c7-f936-40a6-9cca-c21825999d5c" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="45daea73-4d5e-499d-bc93-527d31d00ec3" type="APIKIT:METHOD_NOT_ALLOWED" >
			<flow-ref doc:name="Flow Reference" doc:id="6f63dd9b-84f6-42b7-8d4f-92b3158eb4a8" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="5e5091b9-f5a4-4424-93cb-7571ab61a3ff" type="APIKIT:NOT_ACCEPTABLE" >
			<flow-ref doc:name="Flow Reference" doc:id="1dc4ea02-9c21-4d79-a312-04fe6ae59f48" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="a4c10839-ad82-4230-8a7a-0efb9ad5e4d4" type="APIKIT:UNSUPPORTED_MEDIA_TYPE" >
			<flow-ref doc:name="Flow Reference" doc:id="fab2788f-985b-44d8-be66-3297196a55e6" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="b38c58ae-e093-435a-9ebb-30fe427d29c6" type="APIKIT:NOT_IMPLEMENTED" >
			<flow-ref doc:name="Flow Reference" doc:id="03e78922-f743-4940-a87d-c9f9bb10bd7e" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="93e56fd3-ea33-497b-95f6-6caeede4c683" type="HTTP:BAD_REQUEST, HTTP:CLIENT_SECURITY, HTTP:CONNECTIVITY, HTTP:FORBIDDEN, HTTP:INTERNAL_SERVER_ERROR, HTTP:METHOD_NOT_ALLOWED, HTTP:NOT_ACCEPTABLE, HTTP:NOT_FOUND, HTTP:PARSING, HTTP:RETRY_EXHAUSTED, HTTP:SECURITY, HTTP:SERVICE_UNAVAILABLE, HTTP:TIMEOUT, HTTP:TOO_MANY_REQUESTS, HTTP:UNAUTHORIZED, HTTP:UNSUPPORTED_MEDIA_TYPE">
			<flow-ref doc:name="Flow Reference" doc:id="a8f4d226-8783-4386-9fb8-51007b757b28" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0dc444c1-e895-4c8f-87e7-70e9e8fe6d09" type="HTTP:BAD_GATEWAY">
			<flow-ref doc:name="Flow Reference" doc:id="f3d10f77-0ee8-49aa-aada-44d9bc10bcb5" name="global-config-propagate-error"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="6a9c0982-c6d8-4078-8719-6ed63dd5905c" type="HTTP:GATEWAY_TIMEOUT">
			<flow-ref doc:name="Flow Reference" doc:id="69555d15-7ec1-4f24-a48c-f6fbfbecd36f" name="global-config-propagate-error"/>
			<async doc:name="Async" doc:id="deda6ca0-c5e0-4cf7-860e-643e53a3372f" >
				<flow-ref doc:name="global-config-email-notification" doc:id="340a3895-3ac8-456a-8f1f-ed79891e5d54" name="global-config-email-notification" />
			</async>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="08749404-447a-4ce9-9be5-f918225d19d0" type="ANY">
			<flow-ref doc:name="Flow Reference" doc:id="81eeb1f6-8a23-4e07-a870-cf7300d8c946" name="global-config-propagate-error"/>
			<async doc:name="Async" doc:id="ea7360c9-d459-4b11-a718-4d4de71e7c16">
			<flow-ref doc:name="Flow Reference" doc:id="438dff58-d2d8-4b4f-99f2-1038a14479f3" name="global-config-email-notification" />
		</async>
		
</on-error-propagate>
	</error-handler>
	<sub-flow name="global-config-propagate-error" doc:id="1f65c7e9-aa43-41a4-b943-56d4af259b44" >
		<ee:transform doc:name="Frame Error Message" doc:id="1cd85a03-9f9d-4f7b-b4a1-ce9f49cae91c">
				<ee:message>
				<ee:set-payload resource="dwl/errorResponse.dwl" />

				</ee:message>
			<ee:variables >
			</ee:variables>
			
</ee:transform>
		<json-logger:logger doc:name="Logger" doc:id="12dc725b-80a8-42f8-8001-be80528e52e7" config-ref="JSON_Logger_Config1" message='#["Exception occurred processing the transaction for correlation Id " ++ vars.TransactionID]' tracePoint="EXCEPTION" priority="ERROR" correlationId="#[vars.TransactionID]">
			<json-logger:content ><![CDATA[#[import modules::JSONLoggerModule output application/json ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
		</json-logger:logger>
	
</sub-flow>
	<sub-flow name="global-config-email-notification" doc:id="0880d099-7c81-4775-a226-e11472dad97a" >
		<ee:transform doc:name="Transform Message" doc:id="cca62187-6017-4269-9b88-5f447c9e649f" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var seperator = "/"
---
{
    "apiName": app.name default "",
    "correlationID": vars.TransactionID default "",
    "subsidairy": vars.fileDetails.subsidiary,
    "Source": Mule::p('api.source'),
    "Target": Mule::p('vars.fileDetails.externalSystem'),
    "flowDirection": Mule::p('api.flowDirection'),
    "fileName": vars.fileDetails.flatFileName default "NA",
    "filePath": ("/" ++ Mule::p('api.flowDirection')  ++ "/" ++ lower(vars.fileDetails.subsidiary) ++ "/" ++ lower(vars.fileDetails.externalSystem) ++ vars.sapiHttpPath  ++ "/" ++ lower(vars.fileDetails.flatFileName) ++ "." ++ vars.fileDetails.flatFileExtension) as String default "",
    "errorDetails":{
        "errorCode":payload.errorCode default "",
        "errorDesc":payload.errorMessage default ""
   }}
 ]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<anypoint-mq:publish doc:name="Publish" doc:id="81057d36-8264-49a0-9c2d-99932bfed0bd" config-ref="Anypoint_MQ_Config" destination="${amq.email.publish.path}" />
	</sub-flow>

</mule>
